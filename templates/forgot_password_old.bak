{% extends 'base.html' %}
{% block content %}
  <!-- Template Version: SMS OTP + Email Reset Active - Updated for Testing -->
  <div class="card-header">
    <h1>üîì Forgot Password</h1>
    <p class="note">Choose from multiple recovery options including SMS OTP and secure email reset.</p>
    <p class="version-info" style="font-size: 0.8em; color: #666;">Template updated: 2025-10-16 06:00 UTC - SMS OTP Active</p>
  </div>
  <div class="card-body">
    {% if message %}
      <div class="message {{ 'success' if success else ('error' if error else '') }}">{{ message }}</div>
    {% endif %}
    
    <!-- Password Recovery Options -->
    <div class="recovery-options">
      
      <!-- OPTION 1: SMS OTP PASSWORD RESET -->
      <div class="recovery-card sms-otp-card">
        <div class="recovery-icon">üì±</div>
        <h3>SMS OTP Password Reset</h3>
        <p>Receive a secure OTP code via SMS and reset your password instantly.</p>
        
        <form method="post" class="request-form" id="sms-otp-form">
          <input type="hidden" name="action" value="send_sms_otp">
          
          <div class="form-group">
            <label class="form-label">Select Department:</label>
            <select name="department" class="form-select" required id="sms-department">
              <option value="">Select your department...</option>
              {% for dept in departments %}
                <option value="{{ dept }}">{{ dept }}</option>
              {% endfor %}
            </select>
          </div>
          
          <div class="form-actions">
            <button type="submit" class="btn-primary">Send OTP via SMS</button>
          </div>
        </form>
        
        <!-- OTP Verification Form (initially hidden) -->
        <div id="otp-verification" class="otp-verification-section" style="display: none;">
          <hr class="section-divider">
          <h4>Enter OTP Code</h4>
          <p class="otp-instruction">Enter the 6-digit code sent to your department's registered phone number.</p>
          
          <form method="post" class="request-form">
            <input type="hidden" name="action" value="verify_otp">
            <input type="hidden" name="department" id="otp-department" value="">
            
            <div class="form-group">
              <label class="form-label">OTP Code:</label>
              <input type="text" name="otp_code" class="form-input otp-input" maxlength="6" pattern="[0-9]{6}" required placeholder="123456">
            </div>
            
            <div class="form-group">
              <label class="form-label">New Password:</label>
              <input type="password" name="new_password" class="form-input" required placeholder="Enter new password" minlength="6">
            </div>
            
            <div class="form-group">
              <label class="form-label">Confirm Password:</label>
              <input type="password" name="confirm_password" class="form-input" required placeholder="Confirm new password" minlength="6">
            </div>
            
            <div class="form-actions">
              <button type="submit" class="btn-primary">Reset Password with OTP</button>
              <button type="button" class="btn-secondary" onclick="hideOtpForm()">Cancel</button>
            </div>
          </form>
        </div>
      </div>
      
      <!-- OPTION 2: EMAIL PASSWORD RESET -->
      <div class="recovery-card email-reset-card">
        <div class="recovery-icon">üìß</div>
        <h3>Email Password Reset</h3>
        <p>Send a secure password reset link to your department administrators.</p>
        
        <form method="post" class="request-form">
          <input type="hidden" name="action" value="send_reset_email">
          
          <div class="form-group">
            <label class="form-label">Select Department:</label>
            <select name="department" class="form-select" required>
              <option value="">Select your department...</option>
              {% for dept in departments %}
                <option value="{{ dept }}">{{ dept }}</option>
              {% endfor %}
            </select>
          </div>
          
          <div class="form-actions">
            <button type="submit" class="btn-primary">Send Reset Email</button>
          </div>
        </form>
      </div>
      
      <!-- OPTION 3: CONTACT ADMIN -->
      <div class="recovery-card">
        <div class="recovery-icon">üë®‚Äçüíº</div>
        <h3>Contact System Administrator</h3>
        <p>The quickest way to recover your department password is to contact your system administrator.</p>
        <div class="contact-info">
          <strong>Admin Contact:</strong><br>
          üìß Email: admin@yourcompany.com<br>
          üìû Phone: +1-XXX-XXX-XXXX<br>
          üí¨ Teams: @ITSupport
        </div>
      </div>
      
      <!-- OPTION 4: PASSWORD HINTS -->
      <div class="recovery-card">
        <div class="recovery-icon">üí°</div>
        <h3>Password Hints</h3>
        <p>Department passwords typically follow these patterns:</p>
        <div class="hint-list">
          <div class="hint-item">‚Ä¢ Department name + "123" (e.g., service123)</div>
          <div class="hint-item">‚Ä¢ Department abbreviation + "123" (e.g., toc123)</div>
          <div class="hint-item">‚Ä¢ Check with your team lead or manager</div>
          <div class="hint-item">‚Ä¢ Look for shared team documentation</div>
        </div>
      </div>
      
      <!-- OPTION 5: EMERGENCY REQUEST -->
      <div class="recovery-card">
        <div class="recovery-icon">üÜò</div>
        <h3>Emergency Access Request</h3>
        <p>Submit a request for temporary access to your department.</p>
        
        <form method="post" class="request-form">
          <input type="hidden" name="action" value="emergency_request">
          
          <div class="form-group">
            <label class="form-label">Your Name:</label>
            <input type="text" name="requester_name" class="form-input" required placeholder="Enter your full name">
          </div>
          
          <div class="form-group">
            <label class="form-label">Department:</label>
            <select name="department" class="form-select" required>
              <option value="">Select your department...</option>
              {% for dept in departments %}
                <option value="{{ dept }}">{{ dept }}</option>
              {% endfor %}
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Email (for response):</label>
            <input type="email" name="email" class="form-input" required placeholder="your.email@company.com">
          </div>
          
          <div class="form-group">
            <label class="form-label">Reason for Request:</label>
            <textarea name="reason" class="form-textarea" rows="3" required placeholder="Brief explanation of why you need access..."></textarea>
          </div>
          
          <div class="form-actions">
            <button type="submit" class="btn-primary">Submit Request</button>
          </div>
        </form>
      </div>
      
    </div>
    
    <!-- Back to Login -->
    <div class="back-section">
      <a href="{{ url_for('local_login') }}" class="back-link">‚Üê Back to Login</a>
      <a href="{{ url_for('index') }}" class="back-link">üè† Go to Home</a>
    </div>
    
  </div>
  
  <style>
    .recovery-options {
      display: grid;
      gap: 2rem;
      margin-bottom: 2rem;
    }
    
    .recovery-card {
      background: var(--bg-secondary);
      padding: 2rem;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-color);
      text-align: center;
    }
    
    .sms-otp-card {
      border: 2px solid #10b981;
      background: linear-gradient(135deg, #ecfdf5 0%, var(--bg-secondary) 100%);
    }
    
    .email-reset-card {
      border: 2px solid #3b82f6;
      background: linear-gradient(135deg, #eff6ff 0%, var(--bg-secondary) 100%);
    }
    
    .recovery-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      display: block;
    }
    
    .recovery-card h3 {
      margin: 0 0 1rem 0;
      color: var(--text-primary);
      font-size: 1.3rem;
    }
    
    .recovery-card p {
      color: var(--text-secondary);
      margin-bottom: 1.5rem;
      line-height: 1.6;
    }
    
    .contact-info {
      background: var(--bg-tertiary);
      padding: 1rem;
      border-radius: var(--radius-md);
      font-size: 0.9rem;
      line-height: 1.8;
      color: var(--text-primary);
    }
    
    .hint-list {
      text-align: left;
      max-width: 400px;
      margin: 0 auto;
    }
    
    .hint-item {
      background: var(--bg-tertiary);
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: 0.9rem;
    }
    
    .request-form {
      text-align: left;
      max-width: 400px;
      margin: 0 auto;
    }
    
    .form-group {
      margin-bottom: 1.5rem;
    }
    
    .form-label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--text-primary);
    }
    
    .form-input, .form-select, .form-textarea {
      width: 100%;
      padding: 0.75rem;
      border: 2px solid var(--border-color);
      border-radius: var(--radius-md);
      font-size: 1rem;
      transition: border-color 0.2s ease;
      background: var(--bg-primary);
    }
    
    .form-input:focus, .form-select:focus, .form-textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(100, 116, 139, 0.1);
    }
    
    .form-textarea {
      resize: vertical;
      font-family: inherit;
    }
    
    .form-actions {
      text-align: center;
      margin-top: 2rem;
    }
    
    .btn-primary {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 0.75rem 2rem;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 1rem;
      font-weight: 500;
    }
    
    .btn-primary:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }
    
    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 2px solid var(--border-color);
      padding: 0.75rem 2rem;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 1rem;
      font-weight: 500;
      margin-left: 1rem;
    }
    
    .btn-secondary:hover {
      background: var(--bg-primary);
      border-color: var(--primary-color);
      color: var(--primary-color);
      transform: translateY(-1px);
    }
    
    .otp-verification-section {
      margin-top: 2rem;
      padding-top: 2rem;
    }
    
    .section-divider {
      border: none;
      height: 1px;
      background: var(--border-color);
      margin: 1rem 0;
    }
    
    .otp-verification-section h4 {
      margin: 0 0 1rem 0;
      color: var(--text-primary);
      font-size: 1.2rem;
      text-align: center;
    }
    
    .otp-instruction {
      color: var(--text-secondary);
      margin-bottom: 1.5rem;
      text-align: center;
      font-style: italic;
    }
    
    .otp-input {
      text-align: center;
      font-size: 1.5rem;
      font-weight: bold;
      letter-spacing: 0.3em;
      font-family: 'Courier New', monospace;
    }
    
    .back-section {
      text-align: center;
      margin-top: 3rem;
      padding-top: 2rem;
      border-top: 1px solid var(--border-color);
      display: flex;
      justify-content: center;
      gap: 2rem;
      flex-wrap: wrap;
    }
    
    .back-link {
      color: var(--primary-color);
      text-decoration: none;
      font-weight: 500;
      transition: all 0.2s ease;
      padding: 0.5rem 1rem;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-color);
    }
    
    .back-link:hover {
      background: var(--bg-secondary);
      transform: translateY(-1px);
      color: var(--primary-dark);
    }
    
    .message {
      padding: 1rem;
      border-radius: var(--radius-md);
      margin-bottom: 2rem;
      text-align: center;
      font-weight: 500;
    }
    
    .message.success {
      background: #dcfce7;
      color: #166534;
    }
    
    .message.error {
      background: #fee2e2;
      color: #dc2626;
    }
    
    @media (max-width: 768px) {
      .recovery-options {
        gap: 1.5rem;
      }
      
      .recovery-card {
        padding: 1.5rem;
      }
      
      .back-section {
        flex-direction: column;
        gap: 1rem;
      }
    }
  </style>
  
  <script>
    // Show OTP verification form when SMS is successfully sent
    document.addEventListener('DOMContentLoaded', function() {
      // Check if we have a success message indicating OTP was sent
      const messageDiv = document.querySelector('.message.success');
      if (messageDiv && messageDiv.textContent.includes('OTP sent via SMS')) {
        showOtpForm();
      }
      
      // Handle SMS OTP form submission
      const smsOtpForm = document.getElementById('sms-otp-form');
      if (smsOtpForm) {
        smsOtpForm.addEventListener('submit', function(e) {
          const department = document.getElementById('sms-department').value;
          if (!department) {
            e.preventDefault();
            alert('Please select a department first.');
            return;
          }
          
          // Store department for OTP verification
          document.getElementById('otp-department').value = department;
        });
      }
      
      // Auto-format OTP input (numeric only, max 6 digits)
      const otpInput = document.querySelector('.otp-input');
      if (otpInput) {
        otpInput.addEventListener('input', function(e) {
          // Remove non-numeric characters
          e.target.value = e.target.value.replace(/[^0-9]/g, '');
          // Limit to 6 digits
          if (e.target.value.length > 6) {
            e.target.value = e.target.value.slice(0, 6);
          }
        });
        
        // Auto-submit when 6 digits are entered (optional)
        otpInput.addEventListener('keyup', function(e) {
          if (e.target.value.length === 6) {
            // Focus on next input (new password)
            const nextInput = e.target.closest('.form-group').nextElementSibling.querySelector('.form-input');
            if (nextInput) {
              nextInput.focus();
            }
          }
        });
      }
    });
    
    function showOtpForm() {
      const otpSection = document.getElementById('otp-verification');
      const smsForm = document.getElementById('sms-otp-form');
      
      if (otpSection && smsForm) {
        // Hide the SMS sending form
        smsForm.style.display = 'none';
        
        // Show the OTP verification form
        otpSection.style.display = 'block';
        
        // Focus on OTP input
        const otpInput = otpSection.querySelector('.otp-input');
        if (otpInput) {
          setTimeout(() => otpInput.focus(), 100);
        }
        
        // Scroll to OTP form
        otpSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }
    
    function hideOtpForm() {
      const otpSection = document.getElementById('otp-verification');
      const smsForm = document.getElementById('sms-otp-form');
      
      if (otpSection && smsForm) {
        // Hide the OTP verification form
        otpSection.style.display = 'none';
        
        // Show the SMS sending form
        smsForm.style.display = 'block';
        
        // Reset OTP form
        const otpForm = otpSection.querySelector('form');
        if (otpForm) {
          otpForm.reset();
        }
        
        // Scroll back to SMS form
        smsForm.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }
    
    // Show OTP form if success message contains OTP sent confirmation
    function checkForOtpSent() {
      const urlParams = new URLSearchParams(window.location.search);
      const success = urlParams.get('otp_sent');
      
      if (success === 'true') {
        setTimeout(showOtpForm, 500);
      }
    }
  </script>
{% endblock %}
